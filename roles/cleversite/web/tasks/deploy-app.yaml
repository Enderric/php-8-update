- name: Подготавилваю файловую систему
  file:
    path: "{{app_path}}"
    state: directory
    owner: apache
    group: apache
    mode: '0755'

- name: Получаю приложение из репозитория
  git:
    repo: "{{app_git_repo}}"
    dest: "{{app_path}}"
    version: "{{app_release_commit}}"
    force: yes

- name: Вычищаю cleversite/vendor
  file:
    path: "{{app_path}}/cleversite/vendor"
    state: absent

- name: Устанавливаю зависимости
  shell: composer install -n 
  args:
    chdir: "{{app_path}}/cleversite"

- name: Удаляю ненужные директории
  file:
    state: absent
    path: "{{app_path}}/{{item}}"
  with_items:
    - upload
    - docker
    - .git

- name: Устанавливаю права доступа
  file:
    path: "{{app_path}}"
    state: directory
    owner: apache
    group: apache
    recurse: yes

- name: Проверяю внешние папки
  file:
    path: "{{item.src}}"
    state: directory
    mode: "0775"
    owner: apache
    group: apache
    force: yes
  with_items: "{{app_external_data}}"    

- name: Подключаю внешние папки
  file:
    src: "{{item.src}}"
    dest: "{{app_path}}/{{item.dest}}"
    state: link
    owner: apache
    group: apache
    force: yes
  with_items: "{{app_external_data}}"


- name: Подключаю активный шаблон  
  file:
    src: "{{webtemplate.app_active_release_path}}"
    dest: "{{app_template_dest}}"
    state: link
    owner: apache
    group: apache
    force: yes


- name: Выкладываю .env файл ({{envfile}})
  copy:
    dest: "{{app_basepath}}/{{app_version_name}}.env"
    src: "{{envfile}}"




